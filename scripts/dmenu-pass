#!/usr/bin/env bash

shopt -s nullglob globstar

typeit=0
if [[ $1 == "--type" ]]; then
	typeit=1
	shift
fi

if [[ -n $WAYLAND_DISPLAY ]]; then
	dmenu="wmenu"
	xdotool="wtype"
elif [[ -n $DISPLAY ]]; then
	dmenu="dmenu"
	xdotool="xdotool type --clearmodifiers --file -"
else
	echo "Error: No Wayland or X11 display detected" >&2
	exit 1
fi

prefix="${PASSWORD_STORE_DIR:-$HOME/.password-store}"

# Get all *.gpg files recursively
mapfile -t all_passwords < <(find "$prefix" -type f -name '*.gpg' | sort)

# Strip prefix and .gpg extension, and filter out entries containing "otp"
password_files=()
for path in "${all_passwords[@]}"; do
    relative="${path#$prefix/}"
    name="${relative%.gpg}"
    [[ $name != *otp* ]] && password_files+=("$name")
done

# Show menu and get selection
password=$(printf '%s\n' "${password_files[@]}" | $dmenu "$@")
[[ -n $password ]] || exit 0

if [[ $typeit -eq 0 ]]; then
	pass show -c "$password" 2>/dev/null
else
	$xdotool <<<"$(pass show "$password" | { IFS= read -r first; printf %s "$first"; })"
fi
